<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Captions</title>

<style>
:root{
  --bg:#ffffff;
  --ink:#111;
  --muted:#666;
  --card:#efe9f7;
  --btn:#ffffff;
  --btn-border:#e2e2e7;
  --shadow:0 12px 30px rgba(0,0,0,.08);
  --radius:22px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
  color:var(--ink);
  background:var(--bg);
}
.wrap{max-width:820px;margin:0 auto;padding:22px 18px 40px}

h1{
  margin:6px 0 14px;
  font-weight:900;
  letter-spacing:-.4px;
  font-size:clamp(22px,5.6vw,34px);
}

.modes{
  display:flex;gap:34px;align-items:center;
  margin:10px 0 16px;
  font-weight:650;
  font-size:clamp(15px,4.2vw,18px);
  flex-wrap:wrap;
}
.modes label{display:flex;gap:10px;align-items:center;cursor:pointer}
input[type="radio"]{width:18px;height:18px;accent-color:#111}

.card{
  background:var(--card);
  border:1px solid rgba(0,0,0,.06);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:20px;
}

.head{
  display:flex;align-items:flex-start;gap:14px;flex-wrap:wrap;
  margin-bottom:12px;
}
.brand{
  display:flex;gap:14px;align-items:baseline;
  font-weight:900;
  font-size:clamp(18px,4.6vw,26px);
}
.pill{
  font-size:clamp(12px,3.4vw,16px);
  font-weight:800;
  color:var(--muted);
  padding:2px 10px;
  border-radius:999px;
  border:1px solid rgba(0,0,0,.08);
  background:rgba(255,255,255,.35);
}
.idline{
  width:100%;
  font-weight:850;
  color:#2c2c2c;
  margin-top:2px;
  opacity:.85;
  font-size:clamp(14px,3.8vw,18px);
}

.actions{margin-left:auto;display:flex;gap:12px}
.iconbtn{
  width:48px;height:44px;
  border-radius:12px;
  border:1px solid var(--btn-border);
  background:var(--btn);
  font-weight:900;
  font-size:20px;
  cursor:pointer;
  box-shadow:0 6px 16px rgba(0,0,0,.06);
}
.iconbtn:active{transform:scale(.98)}

.caption{
  white-space:pre-wrap;
  font-weight:700;
  margin:0;
  padding:8px 0 2px;
  font-size:clamp(16px,4.8vw,24px);
  line-height:1.4;
}

.caption-edit{
  width:100%;
  min-height:140px;
  resize:vertical;
  border:1px solid rgba(0,0,0,.12);
  border-radius:14px;
  padding:12px;
  font-family:inherit;
  font-weight:700;
  font-size:clamp(16px,4.8vw,24px);
  line-height:1.4;
  display:none;
}

.toast{
  position:fixed;
  left:50%;
  bottom:26px;
  transform:translateX(-50%);
  background:#111;
  color:#fff;
  padding:10px 16px;
  border-radius:999px;
  font-weight:800;
  opacity:0;
  pointer-events:none;
  transition:.25s;
}
.toast.show{opacity:1}

/* üì± Mobile smaller font */
@media (max-width:768px){
  .caption,
  .caption-edit{
    font-size:12px !important;
    line-height:1.55;
  }
}
@media (max-width:360px){
  .caption,
  .caption-edit{
    font-size:11px !important;
  }
}
</style>
</head>

<body>
<div class="wrap">
  <h1>Orm Kornnaphat X Bvlgari</h1>

  <div class="modes">
    <label><input type="radio" name="platform" value="ig" checked> Instagram</label>
    <label><input type="radio" name="platform" value="x"> X (Twitter)</label>
  </div>

  <div class="card">
    <div class="head">
      <div class="brand">
        <span>Orm Kornnaphat</span>
        <span class="pill" id="pillType">post</span>
      </div>

      <div class="actions">
        <button class="iconbtn" id="btnRand" title="Random">‚ü≥</button>
        <button class="iconbtn" id="btnEdit" title="Edit">T</button>
        <button class="iconbtn" id="btnCopy" title="Copy">‚ßâ</button>
      </div>

      <div class="idline" id="idLine">#0000</div>
    </div>

    <pre class="caption" id="captionBox">Loading‚Ä¶</pre>
    <textarea class="caption-edit" id="captionEdit"></textarea>
  </div>
</div>

<div class="toast" id="toast">Copied</div>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRdPtHYl8KRLNJOXKZ9gC5RPQoF5aHWlwfSHG90HbYRrZPsi2LLv3J2u_WJ8g5f7n16zZPORBaMNqqq/pub?output=csv";

// ‚úÖ DB ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô {id,text} ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏Ç‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö caption ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á
let DB = { ig: [], x: [] };          // [{id,text}]
let unused = { ig: [], x: [] };      // shuffled pool [{id,text}]

let isEditing = false;
let currentText = "";

const els = {
  captionBox: document.getElementById("captionBox"),
  captionEdit: document.getElementById("captionEdit"),
  idLine: document.getElementById("idLine"),
  pillType: document.getElementById("pillType"),
  btnRand: document.getElementById("btnRand"),
  btnEdit: document.getElementById("btnEdit"),
  btnCopy: document.getElementById("btnCopy"),
  toast: document.getElementById("toast"),
};

function showToast(msg){
  els.toast.textContent = msg;
  els.toast.classList.add("show");
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>els.toast.classList.remove("show"),1200);
}

/** ‚úÖ CSV parser ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö comma + quotes */
function parseCSV(text){
  const rows=[]; let row=[]; let cur=""; let inQuotes=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];

    if(c === '"' && inQuotes && n === '"'){ cur += '"'; i++; continue; }
    if(c === '"'){ inQuotes = !inQuotes; continue; }

    if(c === "," && !inQuotes){ row.push(cur); cur=""; continue; }

    if((c === "\n" || c === "\r") && !inQuotes){
      if(c === "\r" && n === "\n") i++;
      row.push(cur); cur="";
      if(row.some(x => (x||"").trim() !== "")) rows.push(row);
      row=[];
      continue;
    }
    cur += c;
  }
  row.push(cur);
  if(row.some(x => (x||"").trim() !== "")) rows.push(row);
  return rows;
}

/** ‚úÖ crypto random ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏•‡∏≥‡πÄ‡∏≠‡∏µ‡∏¢‡∏á (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ % ‡∏ï‡∏£‡∏á ‡πÜ) */
function cryptoRandomInt(max){
  if(max <= 0) return 0;
  const range = 4294967296; // 2^32
  const limit = range - (range % max);
  const arr = new Uint32Array(1);
  let x;
  do{
    crypto.getRandomValues(arr);
    x = arr[0];
  }while(x >= limit);
  return x % max;
}

/** ‚úÖ Fisher‚ÄìYates shuffle (‡πÉ‡∏ä‡πâ crypto) */
function shuffleArray(arr){
  for(let i = arr.length - 1; i > 0; i--){
    const j = cryptoRandomInt(i + 1);
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

async function loadData(){
  try{
    const res = await fetch(SHEET_URL, { cache:"no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    const csv = await res.text();
    const table = parseCSV(csv);

    DB = { ig: [], x: [] };
    unused = { ig: [], x: [] };

    // ‚úÖ ‡∏ô‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡πÅ‡∏¢‡∏Å‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏° + ‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥‡πÅ‡∏ö‡∏ö‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏•‡∏≥‡∏î‡∏±‡∏ö
    const seq  = { ig: 0, x: 0 };
    const seen = { ig: new Set(), x: new Set() };

    // skip header row
    for(let i=1;i<table.length;i++){
      const platform = (table[i][0]||"").trim().toLowerCase();
      const text = (table[i][1]||"").trim();
      if(!text) continue;
      if(platform !== "ig" && platform !== "x") continue;

      // ‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥ (‡∏ñ‡πâ‡∏≤‡∏ã‡πâ‡∏≥‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏Ç)
      if(seen[platform].has(text)) continue;
      seen[platform].add(text);

      // ‚úÖ id = ‡∏•‡∏≥‡∏î‡∏±‡∏ö caption ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ô‡∏±‡πâ‡∏ô (‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏î‡∏ã‡πâ‡∏≥)
      seq[platform] += 1;
      DB[platform].push({ id: seq[platform], text });
    }

    if(DB.ig.length === 0 && DB.x.length === 0){
      els.captionBox.textContent = "No captions found. Check sheet headers: platform,text";
      els.idLine.textContent = "#0000";
      return;
    }

    generate();
  }catch(err){
    els.captionBox.textContent = "Load failed: " + err.message;
    els.idLine.textContent = "#0000";
  }
}

function getPlatform(){
  return document.querySelector('input[name="platform"]:checked').value;
}

function generate(){
  if(isEditing) return;

  const p = getPlatform();
  const pool = DB[p] || [];

  if(pool.length === 0){
    currentText = "No captions for this platform yet.";
    els.captionBox.textContent = currentText;
    els.pillType.textContent = p==="ig" ? "post" : "tweet";
    els.idLine.textContent = "#0000";
    return;
  }

  // ‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏•‡πâ‡∏ß shuffle ‡∏ó‡∏±‡πâ‡∏á‡∏Å‡πâ‡∏≠‡∏ô -> ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏à‡∏ô‡∏´‡∏°‡∏î‡∏ä‡∏∏‡∏î (‡πÅ‡∏¢‡∏Å‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°)
  if(!unused[p] || unused[p].length === 0){
    unused[p] = [...pool];
    shuffleArray(unused[p]);
  }

  // ‚úÖ ‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ item ‡πÑ‡∏´‡∏ô ‡∏Å‡πá‡πÉ‡∏ä‡πâ id ‡∏Ç‡∏≠‡∏á item ‡∏ô‡∏±‡πâ‡∏ô
  const item = unused[p].pop();   // {id,text}
  currentText = item.text;

  els.captionBox.textContent = currentText;
  els.pillType.textContent = p==="ig" ? "post" : "tweet";
  els.idLine.textContent = "#" + String(item.id).padStart(4,"0");
}

function toggleEdit(){
  isEditing = !isEditing;
  if(isEditing){
    els.captionEdit.style.display = "block";
    els.captionBox.style.display  = "none";
    els.captionEdit.value = currentText;
    els.captionEdit.focus();
  }else{
    currentText = (els.captionEdit.value || "").trim();
    els.captionBox.textContent = currentText || "‚Äî";
    els.captionEdit.style.display = "none";
    els.captionBox.style.display  = "block";
  }
}

async function copyCaption(){
  try{
    await navigator.clipboard.writeText(currentText || "");
    showToast("Copied");
  }catch{
    showToast("Copy failed");
  }
}

els.btnRand.addEventListener("click", generate);
els.btnEdit.addEventListener("click", toggleEdit);
els.btnCopy.addEventListener("click", copyCaption);

// ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô platform ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏ä‡∏∏‡∏î‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡πÉ‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏á‡∏°‡∏±‡∏ô)
document.querySelectorAll('input[name="platform"]').forEach(r=>{
  r.addEventListener("change", generate);
});

loadData();
</script>
</body>
</html>
