<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRdPtHYl8KRLNJOXKZ9gC5RPQoF5aHWlwfSHG90HbYRrZPsi2LLv3J2u_WJ8g5f7n16zZPORBaMNqqq/pub?output=csv";

let DB = { ig: [], x: [] };
let currentText = "";
let isEdit = false;

const captionBox = document.getElementById("captionBox");
const pillType = document.getElementById("pillType");
const toast = document.getElementById("toast");
const editBtn = document.getElementById("btnEdit");

function showToast(){
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"),1000);
}

/** ✅ CSV parser ที่รองรับ comma ในข้อความ (quoted CSV) */
function parseCSV(text){
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for(let i=0;i<text.length;i++){
    const ch = text[i];
    const next = text[i+1];

    if(ch === '"' && inQuotes && next === '"'){ // escaped quote ""
      cur += '"'; i++;
      continue;
    }
    if(ch === '"'){ inQuotes = !inQuotes; continue; }

    if(ch === ',' && !inQuotes){
      row.push(cur);
      cur = "";
      continue;
    }

    if((ch === '\n' || ch === '\r') && !inQuotes){
      if(ch === '\r' && next === '\n') i++;
      row.push(cur);
      if(row.some(v => v.trim() !== "")) rows.push(row);
      row = [];
      cur = "";
      continue;
    }

    cur += ch;
  }
  row.push(cur);
  if(row.some(v => v.trim() !== "")) rows.push(row);

  return rows;
}

/** ✅ map platform ให้ชัวร์ว่าเป็น ig หรือ x */
function normalizePlatform(raw){
  const p = (raw || "").trim().toLowerCase();
  if(p === "ig" || p === "instagram") return "ig";
  if(p === "x" || p === "twitter" || p.includes("x") || p.includes("twitter")) return "x";
  return ""; // ไม่รู้จัก ไม่เก็บ
}

async function loadData(){
  const res = await fetch(SHEET_URL, { cache:"no-store" });
  const csv = await res.text();

  const table = parseCSV(csv);
  // ข้าม header แถวแรก
  const dataRows = table.slice(1);

  DB = { ig: [], x: [] };

  dataRows.forEach(cols=>{
    const platformRaw = cols[0];
    const textRaw = cols[1];

    const key = normalizePlatform(platformRaw);
    const text = (textRaw || "").trim();

    if(key && text){
      DB[key].push(text);
    }
  });

  // ✅ debug สั้น ๆ (ถ้าอยากดูจำนวน)
  // console.log("IG:", DB.ig.length, "X:", DB.x.length);
}

function generate(){
  const p = document.querySelector('input[name="platform"]:checked').value;
  const arr = DB[p] || [];
  if(arr.length===0){
    captionBox.textContent = `No captions available for ${p.toUpperCase()}.`;
    return;
  }
  const rand = arr[Math.floor(Math.random()*arr.length)];
  currentText = rand;
  captionBox.textContent = rand;
  pillType.textContent = p==="ig" ? "post" : "tweet";
}

document.getElementById("btnRand").addEventListener("click", async ()=>{
  captionBox.textContent="Loading...";
  await loadData();
  generate();
});

document.getElementById("btnCopy").addEventListener("click", async ()=>{
  if(!captionBox.textContent.trim()) return;
  await navigator.clipboard.writeText(captionBox.textContent);
  showToast();
});

editBtn.addEventListener("click", ()=>{
  isEdit = !isEdit;
  captionBox.contentEditable = isEdit;
  captionBox.style.outline = isEdit ? "2px solid #c6a75e" : "none";
  editBtn.classList.toggle("active", isEdit);
});
</script>
